# 1. 基础镜像: riscv64/debian:trixie
ARG ARM_ARCH=riscv64
FROM ${ARM_ARCH}/debian:trixie

# 2. 设置环境变量
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && \
    apt-get install -y locales && \
    sed -i -e 's/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen && \
    dpkg-reconfigure --frontend=noninteractive locales && \
    update-locale LANG=en_US.UTF-8
ENV LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8 LANGUAGE=en_US:en

# 3. 安装依赖 (APT)
# 注意：这里我们安装的是编译 Python 3.11 所需的构建依赖 (libssl-dev, zlib1g-dev 等)
# 以及 ROS 2 需要的 C++ 库。
RUN apt-get update && \
    apt-get install -y \
    build-essential cmake git curl wget \
    # Python 编译依赖 (必须全)
    libssl-dev zlib1g-dev libncurses5-dev libncursesw5-dev \
    libreadline-dev libsqlite3-dev libgdbm-dev libdb5.3-dev libbz2-dev \
    libexpat1-dev liblzma-dev libffi-dev uuid-dev \
    # ROS 2 核心 C++ 库
    libeigen3-dev libacl1-dev libldap-dev \
    liblttng-ust-dev liblttng-ctl-dev \
    libfmt-dev libspdlog-dev libtinyxml2-dev libasio-dev \
    libxml2-dev libxslt-dev libyaml-cpp-dev \
    libcurl4-openssl-dev libzip-dev libgts-dev libbullet-dev \
    libfreetype6-dev libopencv-dev ninja-build \
    && rm -rf /var/lib/apt/lists/*

# 4. --- <--- 关键步骤：手动编译 Python 3.11.9 ---
# 下载源码 -> 配置 -> 编译 -> 安装
WORKDIR /tmp
RUN wget https://www.python.org/ftp/python/3.11.9/Python-3.11.9.tgz \
    && tar -xvf Python-3.11.9.tgz \
    && cd Python-3.11.9 \
    # --enable-shared: 生成 libpython3.11.so (ROS 需要)
    # --prefix=/usr: 安装到系统目录，替换系统默认 python
    && ./configure --enable-shared --prefix=/usr LDFLAGS="-Wl,-rpath=/usr/lib" \
    && make -j$(nproc) \
    && make install \
    && cd .. && rm -rf Python-3.11.9*

# 5. 验证与修复
# 此时 /usr/bin/python3 应该已经是 3.11 了。
# 我们需要重新安装 pip (针对 3.11)
RUN python3 -m ensurepip --upgrade && python3 -m pip install --upgrade pip

# 6. 安装 ROS Python 依赖 (PIP)
# 因为现在的 python3 是我们刚编译的纯净版 3.11，系统 apt 安装的 python3-yaml 等包(属于3.13)无法使用
# 所以必须全部用 pip 安装一遍
ENV PIP_BREAK_SYSTEM_PACKAGES=1
RUN pip3 install -U \
    colcon-common-extensions \
    vcstool \
    rosdepc \
    numpy \
    pyyaml==6.0.1 \
    lark==1.1.9 \
    empy==3.3.4 \
    catkin_pkg==1.0.0 \
    netifaces \
    typing_extensions \
    pytest==7.4.4

# 7. 初始化 rosdepc
RUN rosdepc init && rosdepc update
# 8. 创建工作区
RUN mkdir -p /ros2_ws/src
WORKDIR /ros2_ws
# 下载源码 + 修正 mimick + 下载 ros_base 定义
RUN wget https://raw.githubusercontent.com/jialog0301/ros2/jazzy/ros2.repos \
    && vcs import src < ros2.repos \
    && git clone -b jazzy https://github.com/ros2/variants src/ros2/variants

# 9. 安装源码依赖
RUN rosdepc install -i --from-path src --rosdistro jazzy -y \
    --skip-keys "fastrtps rti-connext-dds-6.0.1 mimick python3-mypy sip python3-sip qt_gui_cpp"

# 11. 编译 ROS 2 (Python 3.11 版)
# 强制指定 Python 路径，确保万无一失
RUN colcon build --event-handlers console_cohesion+ \
    --merge-install \
    --install-base /opt/ros/jazzy \
    --packages-up-to ros_base \
    --cmake-args -Wno-dev -DBUILD_TESTING=OFF -DCMAKE_BUILD_TYPE=Release \
    -DPython3_EXECUTABLE=/usr/bin/python3.11

# 12. 设置环境
ENV QT_X11_NO_MITSHM=1
RUN echo "source /opt/ros/jazzy/setup.bash" >> ~/.bashrc
WORKDIR /
CMD ["bash"]
